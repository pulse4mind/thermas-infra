version: "3.7"

x-evolution-env: &evolution_env
  TZ: ${TZ}
  DOCKER_ENV: "true"
  SERVER_URL: "https://${DOMAIN_EVO}"

  # Autenticação
  AUTHENTICATION_TYPE: "apikey"

  # Banco
  DATABASE_ENABLED: "true"
  DATABASE_PROVIDER: "postgresql"

  # Cache / Redis
  CACHE_REDIS_ENABLED: "true"
  CACHE_LOCAL_ENABLED: "false"
  CACHE_REDIS_PREFIX_KEY: "${EVO_CACHE_PREFIX}"
  EVO_CACHE_REDIS_DB: "${EVO_CACHE_REDIS_DB}"

  # Logs
  LOG_LEVEL: "${EVO_LOG_LEVEL}"

services:
  evolution_api:
    image: evoapicloud/evolution-api:v2.3.7

    entrypoint: ["/bin/sh", "-lc"]
    command:
      - |
        set -eu

        echo "== Evolution bootstrap starting =="

        # Garantia de secrets
        test -f /run/secrets/postgres_password || { echo "ERROR missing postgres_password"; exit 1; }
        test -f /run/secrets/redis_password || { echo "ERROR missing redis_password"; exit 1; }
        test -f /run/secrets/evolution_api_key || { echo "ERROR missing evolution_api_key"; exit 1; }

        # API Key
        AUTHENTICATION_API_KEY="$(cat /run/secrets/evolution_api_key | tr -d '\r\n')"

        # Encode senha Postgres (senha forte)
        POSTGRES_PASSWORD_ENC="$(node -e "process.stdout.write(encodeURIComponent(require('fs').readFileSync('/run/secrets/postgres_password','utf8').trim()))")"

        # Encode senha Redis
        REDIS_PASSWORD_ENC="$(node -e "process.stdout.write(encodeURIComponent(require('fs').readFileSync('/run/secrets/redis_password','utf8').trim()))")"

        # Hosts
        PG_HOST="${POSTGRES_HOST:-postgres}"
        PG_PORT="${POSTGRES_PORT:-5432}"
        RD_HOST="${REDIS_HOST:-redis}"
        RD_PORT="${REDIS_PORT:-6379}"

        # DB
        DB_NAME="${EVO_DB_NAME:-evolution_db}"
        DB_SCHEMA="${EVO_DB_SCHEMA:-evolution_api}"

        # URIs
        DB_URI="postgresql://postgres:${POSTGRES_PASSWORD_ENC}@${PG_HOST}:${PG_PORT}/${DB_NAME}?schema=${DB_SCHEMA}"
        REDIS_URI="redis://:${REDIS_PASSWORD_ENC}@${RD_HOST}:${RD_PORT}/${EVO_CACHE_REDIS_DB}"

        export AUTHENTICATION_API_KEY
        export DATABASE_URL="$DB_URI"
        export DATABASE_CONNECTION_URI="$DB_URI"
        export CACHE_REDIS_URI="$REDIS_URI"

        echo "== AFTER EXPORTS (safe) =="
        if [ -n "${DATABASE_URL:-}" ]; then
          echo "DATABASE_URL set? yes"
        else
          echo "DATABASE_URL set? no"
        fi

        if [ -n "${CACHE_REDIS_URI:-}" ]; then
          echo "CACHE_REDIS_URI set? yes"
        else
          echo "CACHE_REDIS_URI set? no"
        fi

        if [ -n "${AUTHENTICATION_API_KEY:-}" ]; then
          echo "AUTHENTICATION_API_KEY set? yes"
        else
          echo "AUTHENTICATION_API_KEY set? no"
        fi

        # Migrations (idempotente)
        echo "== Running migrations =="
        npm run db:deploy

        echo "== Starting Evolution =="
        exec npm run start:prod

    environment:
      <<: *evolution_env

    networks:
      - edge
      - data

    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store

    secrets:
      - evolution_api_key
      - postgres_password
      - redis_password

    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.docker.network=${EDGE_NETWORK}
        - traefik.http.routers.evolution.rule=Host(`${DOMAIN_EVO}`)
        - traefik.http.routers.evolution.entrypoints=websecure
        - traefik.http.routers.evolution.tls.certresolver=letsencryptresolver
        - traefik.http.services.evolution.loadbalancer.server.port=8080

secrets:
  evolution_api_key:
    external: true
    name: thermas_prod_evolution_api_key

  postgres_password:
    external: true
    name: thermas_prod_postgres_password

  redis_password:
    external: true
    name: thermas_prod_redis_password

volumes:
  evolution_instances:
    external: true
    name: thermas_prod_evolution_instances

  evolution_store:
    external: true
    name: thermas_prod_evolution_store

networks:
  edge:
    external: true
    name: "${EDGE_NETWORK}"

  data:
    external: true
    name: "${DATA_NETWORK}"
