version: "3.7"

x-chatwoot-env: &chatwoot_env
  INSTALLATION_NAME: chatwoot
  NODE_ENV: production
  RAILS_ENV: production
  INSTALLATION_ENV: docker

  SECRET_KEY_BASE: ${CHATWOOT_SECRET_KEY_BASE}

  FRONTEND_URL: https://${DOMAIN_CHAT}
  ASSET_CDN_HOST: https://${DOMAIN_CHAT}

  DEFAULT_LOCALE: ${CHATWOOT_DEFAULT_LOCALE}
  FORCE_SSL: "true"
  ENABLE_ACCOUNT_SIGNUP: "${CHATWOOT_ENABLE_SIGNUP}"

  REDIS_URL: redis://redis:6379

  POSTGRES_HOST: postgres
  POSTGRES_USERNAME: ${CHATWOOT_POSTGRES_USER}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  POSTGRES_DATABASE: ${CHATWOOT_POSTGRES_DB}

  ACTIVE_STORAGE_SERVICE: local
  RAILS_LOG_TO_STDOUT: "true"
  USE_INBOX_AVATAR_FOR_BOT: "true"

  MAILER_SENDER_EMAIL: ${CHATWOOT_MAILER_SENDER}
  SMTP_DOMAIN: ${SMTP_DOMAIN}
  SMTP_ADDRESS: ${SMTP_ADDRESS}
  SMTP_PORT: "${SMTP_PORT}"
  SMTP_USERNAME: ${SMTP_USERNAME}
  SMTP_PASSWORD: ${SMTP_PASSWORD}
  SMTP_AUTHENTICATION: ${SMTP_AUTHENTICATION}
  SMTP_ENABLE_STARTTLS_AUTO: "${SMTP_STARTTLS}"
  SMTP_OPENSSL_VERIFY_MODE: ${SMTP_OPENSSL_VERIFY_MODE}
  MAILER_INBOUND_EMAIL_DOMAIN: ${MAILER_INBOUND_EMAIL_DOMAIN}

services:
  chatwoot_app:
    image: chatwoot/chatwoot:v4.9.2
    command: bundle exec rails s -p 3000 -b 0.0.0.0
    entrypoint: docker/entrypoints/rails.sh
    volumes:
      - chatwoot_data:/app/storage
    networks:
      - edge
    environment:
      <<: *chatwoot_env
    secrets:
      - chatwoot_secret_key_base
      - postgres_password
      - smtp_password
    deploy:
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.chatwoot.rule=Host(`${DOMAIN_CHAT}`)
        - traefik.http.routers.chatwoot.entrypoints=websecure
        - traefik.http.routers.chatwoot.tls.certresolver=letsencryptresolver
        - traefik.http.services.chatwoot.loadbalancer.server.port=3000
        - traefik.http.middlewares.chatwoot-sslheader.headers.customrequestheaders.X-Forwarded-Proto=https
        - traefik.http.routers.chatwoot.middlewares=chatwoot-sslheader@docker

  chatwoot_sidekiq:
    image: chatwoot/chatwoot:v4.9.2
    command: bundle exec sidekiq -C config/sidekiq.yml
    volumes:
      - chatwoot_data:/app/storage
    networks:
      - data
    environment:
      <<: *chatwoot_env
    secrets:
      - chatwoot_secret_key_base
      - postgres_password
      - smtp_password
    deploy:
      placement:
        constraints:
          - node.role == manager

secrets:
  chatwoot_secret_key_base:
    external: true
    name: "${TENANT}_${ENV}_chatwoot_secret_key_base"
  postgres_password:
    external: true
    name: "${TENANT}_${ENV}_postgres_password"
  smtp_password:
    external: true
    name: "${TENANT}_${ENV}_smtp_password"

volumes:
  chatwoot_data:
    external: true
    name: "${TENANT}_${ENV}_chatwoot_data"

networks:
  edge:
    external: true
    name: "${DOCKER_NETWORK}"
  data:
    external: true
    name: "${DOCKER_NETWORK}"
